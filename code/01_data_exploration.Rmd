---
title: "PhillyStat360 Vacant Property Indicators"
subtitle: "01 数据探索"
author: "MUSA Practicum Team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## 0. 加载包和设置路径

```{r load-packages}
library(tidyverse)
library(janitor)
library(knitr)  # 用于好看的表格输出

# 设置数据路径 - 队友需要修改这里
data_path <- "../rawdata/"
```

---

## 1. 违规定义表 - 找出VACANT相关代码

```{r violation-definition}
violation_def <- read_csv(paste0(data_path, "VIOLATION_DEFINITION.csv"), 
                          show_col_types = FALSE) %>%
  clean_names()

# 筛选vacant相关的违规代码
vacant_violations <- violation_def %>%
  filter(str_detect(tolower(violation_code_title), "vacant") |
         str_detect(tolower(violation_definition), "vacant"))

# 显示结果
kable(vacant_violations %>% select(violation_code, violation_code_title),
      caption = "VACANT相关的违规代码（共54个）")
```

**重要发现：** 有54个和"空置"相关的违规代码，其中最重要的是：

- `9-3904` - VACANT LOT LICENSE（空置地块许可证）
- `9-3905` - VACANT STRUCTURE LICENSE（空置建筑许可证）
- `PM15-901.1` - VACANT & OPEN PROPERTIES（空置开放房产）

---

## 2. 危险建筑数据 (imm_dang)

```{r imm-dang}
imm_dang <- read_csv(paste0(data_path, "imm_dang.csv"), 
                     show_col_types = FALSE) %>%
  clean_names()

cat("行数:", nrow(imm_dang), "\n")
cat("列数:", ncol(imm_dang), "\n")
```

```{r imm-dang-cols}
# 列名
names(imm_dang)
```

```{r imm-dang-sample}
# 查看前几行关键字段
imm_dang %>%
  select(opa_account_num, address, violationcode, violationdate, casecreateddate) %>%
  head(10) %>%
  kable(caption = "危险建筑数据示例")
```

---

## 3. 不安全建筑数据 (unsafe)

```{r unsafe}
unsafe <- read_csv(paste0(data_path, "unsafe.csv"), 
                   show_col_types = FALSE) %>%
  clean_names()

cat("行数:", nrow(unsafe), "\n")
cat("列数:", ncol(unsafe), "\n")
```

```{r unsafe-cols}
names(unsafe)
```

---

## 4. 主表：房产基本信息 (opa_properties_public)

这个文件很大（305MB），先读前1000行看结构。

```{r properties-sample}
properties_sample <- read_csv(paste0(data_path, "opa_properties_public.csv"), 
                               n_max = 1000,
                               show_col_types = FALSE) %>%
  clean_names()

cat("列数:", ncol(properties_sample), "\n")
```

```{r properties-cols}
# 列名（79个字段！）
names(properties_sample)
```

```{r properties-key-fields}
# 关键字段示例
properties_sample %>%
  select(parcel_number, location, owner_1, year_built, 
         total_livable_area, market_value, sale_date, sale_price) %>%
  head(10) %>%
  kable(caption = "房产基本信息示例")
```

**关联字段：** `parcel_number` 是主键，对应其他表的 `opa_account_num`

---

## 5. Clean & Seal 数据

```{r clean-seal}
clean_seal_sample <- read_csv(paste0(data_path, "clean_seal.csv"), 
                               n_max = 1000,
                               show_col_types = FALSE) %>%
  clean_names()

cat("行数（样本）:", nrow(clean_seal_sample), "\n")
cat("列数:", ncol(clean_seal_sample), "\n")
```

```{r clean-seal-cols}
names(clean_seal_sample)
```

```{r clean-seal-sample}
clean_seal_sample %>%
  select(opa_account_num, address, casecreateddate, workordertype, workorderstatus) %>%
  head(10) %>%
  kable(caption = "Clean & Seal数据示例")
```

---

## 6. Violations 数据

```{r violations}
violations_sample <- read_csv(paste0(data_path, "violations.csv"), 
                               n_max = 1000,
                               show_col_types = FALSE) %>%
  clean_names()

cat("行数（样本）:", nrow(violations_sample), "\n")
cat("列数:", ncol(violations_sample), "\n")
```

```{r violations-cols}
names(violations_sample)
```

### 查看违规代码分布

```{r violations-codes}
# 前1000行中的violation_code频率（前20个）
violations_sample %>%
  count(violationcode, sort = TRUE) %>%
  head(20) %>%
  kable(caption = "违规代码频率（前20）")
```

### 筛选VACANT相关的违规

```{r vacant-violations-sample}
# 在样本中找vacant相关的违规
violations_sample %>%
  filter(str_detect(violationcode, "9-3904|9-3905|PM15-901")) %>%
  select(opa_account_num, address, violationcode, violationcodetitle, violationdate) %>%
  head(20) %>%
  kable(caption = "VACANT相关违规示例")
```

**发现：** 前1000行中有：
- `9-3905` (VACANT STRUCTURE LICENSE): 96条
- `PM15-901.1` (VACANT & OPEN PROPERTIES): 11条

---

## 7. Business Licenses 数据

```{r licenses}
licenses_sample <- read_csv(paste0(data_path, "business_licenses.csv"), 
                             n_max = 1000,
                             show_col_types = FALSE) %>%
  clean_names()

cat("行数（样本）:", nrow(licenses_sample), "\n")
cat("列数:", ncol(licenses_sample), "\n")
```

```{r licenses-cols}
names(licenses_sample)
```

### 查看License类型分布

```{r license-types}
licenses_sample %>%
  count(licensetype, sort = TRUE) %>%
  kable(caption = "License类型分布")
```

### 筛选Vacant Property License

```{r vacant-licenses}
licenses_sample %>%
  filter(str_detect(licensetype, "Vacant")) %>%
  select(opa_account_num, address, licensetype, licensestatus, initialissuedate, expirationdate) %>%
  head(20) %>%
  kable(caption = "Vacant Property License示例")
```

**发现：** 前1000行中有92条 `Vacant Residential Property / Lot` 许可证

---

## 8. 关联字段确认

```{r join-fields}
cat("=== 各数据集的关联字段 ===\n\n")

cat("properties: parcel_number\n")
cat("示例:", head(properties_sample$parcel_number, 3), "\n\n")

cat("clean_seal: opa_account_num\n")
cat("示例:", head(clean_seal_sample$opa_account_num, 3), "\n\n")

cat("violations: opa_account_num\n")
cat("示例:", head(violations_sample$opa_account_num, 3), "\n\n")

cat("licenses: opa_account_num\n")
cat("示例:", head(licenses_sample$opa_account_num, 3), "\n")
```
# 看assessments.csv的结构
````{r assessments}
assessments_sample <- read_csv(paste0(data_path, "assessments.csv"),
                                n_max = 1000,
                                show_col_types = FALSE) %>%
  clean_names()

cat("列数:", ncol(assessments_sample), "\n")
cat("列名:\n")
print(names(assessments_sample))

# 看看有什么字段
head(assessments_sample, 5)
````



**结论：** 所有数据都可以通过 `opa_account_num`（= `parcel_number`）关联！

---

## 9. 总结

### 数据概览

| 数据文件 | 用途 | 关联字段 |
|----------|------|----------|
| opa_properties_public.csv | 主表：房产基本信息 | parcel_number |
| clean_seal.csv | OVS定义：被封房产 | opa_account_num |
| violations.csv | OVS定义 + 特征：违规记录 | opa_account_num |
| business_licenses.csv | OVS定义：空置许可证 | opa_account_num |
| unsafe.csv | 特征：不安全建筑 | opa_account_num |
| imm_dang.csv | 特征：危险建筑 | opa_account_num |

### OVS定义（空置状态）

一个房产在某时间点被认定为"空置"（OVS=1），如果满足以下任一条件：

1. **Clean & Seal记录** - 在clean_seal.csv中有记录
2. **Vacant Violation** - 在violations.csv中有以下违规代码：
   - `9-3904` - VACANT LOT LICENSE
   - `9-3905` - VACANT STRUCTURE LICENSE  
   - `PM15-901.1` - VACANT & OPEN PROPERTIES
3. **Vacant Property License** - 在business_licenses.csv中licensetype包含"Vacant"

### 下一步

1. 读取完整数据（用R，不用Excel）
2. 构建Panel Data（每个房产×每个季度）
3. 为每个房产-时间点计算OVS
4. 构建特征变量
5. 建模

